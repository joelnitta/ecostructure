---
title: "Guided ecostructure Tutorial"
shorttitle: "ecostructure"
author:
  - name: Kushal K Dey
    affiliation:
        - Department of Statistics, University of Chicago
  - name: Alexander E. White
    affiliation:
        - Department of Ecology and Evolution, University of Chicago 
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8} ---
  date: "`r Sys.Date()`"
---


```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(dpi = 90,dev = "png")
```


## Introduction

**ecostructure** is a R package for clustering and visualization of species
abundance or presence absence data. **ecostructure** also enables tracking 
distribution of species abundances along different axes of diversity -
taxonomy, phylogeny, trait and spatial. 

Although the illustrations here focus on bird species, the tools and methods 
from this paper can be applied to any other species data. 

The main contributions of the **ecostructure** package are as follows 

- Open access to local bird abundance data collected by 
  Trevor D. Price  and Dhananjay Mohan from 38 sites of the Western and 
  Eastern Himalayas.
  
- Tools to process taxonomic data along different axes of biodiversity-
  phylogenetic, trait and regional.
  
- Functions to cluster the species abundance or presence-absence data
  to identify species communities along different lines of diversity.
  
- New visualization methods to show the structure of species communities


Next, we present an elaborate guided tutorial of how to use the **ecostructure**
R package.

## Installation

**ecostructure** requires the user to have R version $>= 3.4.0$. 

To install **ecostructure**, follow the steps below

```{r echo=TRUE, eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("Biobase")
install.packages("devtools")
devtools::install_github("kkdey/ecostructure")
```

This will install **ecostructure** along with all its dependencies. 

Next, load the package into R.

```{r warning=FALSE, message=FALSE}
library(Biobase)
library(ecostructure)
```


## Data 

We present the taxonomic abundance data for 304 bird species across 38 Himalayan
forest patches, together with the grid metadata and species metadata. The data 
has been collected by our collaborators Trevor D. Price and Dhananjai Mohan 
and is reported in the paper here. 

The data is saved as an ExpressionSet object and can be read as follows

```{r}
data("himalayan_birds")
```

One can extract the *species abundance data* as follows 

```{r}
taxonomic_counts <- t(exprs(himalayan_birds))
taxonomic_counts[1:5,1:5]
```

The *site metadata* for the Himalayan sites - comprising of elevation,
east/west, latitude, longitude - can be extracted as follows.

```{r}
site_metadata <- pData(phenoData(himalayan_birds))
head(site_metadata)
```

Finally, the *species metadata*, comprising of the bill traits, wing size, tarsus
and mass of the birds, can be read as follows

```{r}
species_metadata <- pData(featureData(himalayan_birds))
head(species_metadata, 4)
```

Besides this data, **ecostructure** also provides birds presence absence data
computed from publicly available shapefiles from the entire continent of 
Australia.

```{r}
data("australia_birds")
```


## Model and Visualization

### Presence-absence data

We use `ecostructure_fit` function to run Grade of Membership models on the 
binary presence-absence data or the species abundance counts data (using a 
Binomia/Bernoulli model). 

```{r echo=TRUE, eval=FALSE}
presence_absence_data <- australia_birds$pr_ab_data
topic_clus <- ecostructure_fit(presence_absence_data, K = 6, tol = 0.1)
```

The above code takes a couple of minutes on a single machine. 

The above function outputs a lower rank representation of the data `australia_birds`.
The main components are 

- `omega` : A site $\times$ K matrix, K representing the number of clusters 
          or underlying communities. The row sums equal 1 and the entries 
          are positive. These represent the memberships of different 
          communities represented in each site.
          
- `theta` : A species $\times$ K matrix, where the column sums equal 1. These
          represents the contribution of the bird species in each cluster.
          
  
We can take the output from the model fit and visualize the membership 
proportions `omega` as follows.

```{r}
data("australia_model")
ecostructure_plot_pie(omega = australia_model$omega,
                      coords = australia_birds$latlong, 
                      long_lim = c(110,160),
                      lat_lim = c(-50,-10),
                      path = "geostructure_plot.tiff",
                      color= c("orange", "red", "yellow", "deepskyblue", 
                               "chartreuse", "blue"))

```

This function will create a file `geostructure_plot.png` in the current folder
(`getwd()` in R to figure out). The plot should look as follows 

![australia](geostructure_plot.tiff)

The different colors in this plot represent the different communities and we see
these communities match very well with the different climatic regimes in 
Australia.

The bird species driving these species communities can be derived from the `theta`
matrices. The top 5 species driving each cluster are

```{r}
features <- CountClust::ExtractTopFeatures(australia_model$theta, top_features = 5,
                                           method = "poisson", options = "max")
apply(features$indices, c(1,2), function(x) return(rownames(australia_model$theta)[x]))
```

### Abundance counts data

`ecostructure_fit` can also take as input a matrix of counts of species 
abundances and fits a Multinomial model instead. 

```{r message=FALSE, earning=FALSE}
fit <- ecostructure_fit(taxonomic_counts, K = 2, tol = 0.1, num_trials = 10)
```

Once again the output `fit` consists of the `omega` and `theta` components.
Since this data is not very spatial, we do not use `ecostructure_plot_pie` as 
in the previous example. Instead we stack the membership proportions in a stacked
bar chart.

```{r fig.height=5, fig.width= 6, fig.align='center'}
east_west_dir <- site_metadata$WorE
elevation_metadata <- site_metadata$Elevation
ecostructure_blocks(fit$omega,
                    blocker_metadata = east_west_dir,
                    order_metadata = elevation_metadata)
```

The `blocker_metadata` can be used to block the stacked bar charts into 
meaningful groups (as is East/West in this case) and the `order_metadata` 
determines the order of the stacked bars in each block.

The driving bird species in each cluster can be computed as follows 

```{r}
features <- CountClust::ExtractTopFeatures(fit$theta, top_features = 5,
                                           method = "poisson", options = "max")
apply(features$indices, c(1,2), function(x) return(rownames(fit$theta)[x]))
```


The clustering can be assessed by comparing the fitted model with that on null
generated matrices.

```{r}
out <- ecostructure_nullmodel(taxonomic_counts, K=2, 
                              iter_randomized=5, option = "BF")
```


## Data Processing 

The taxonomic data can be processed along different axes of biodiversity -
namely phylogenetic and trait as follows

### Phylogeny

We load the phylogenetic tree data `phylo_tree` for 304 species and then use
that to collapse the bird species at a certain level on the tree, 
based on `collapse_at`.

```{r}
data("phylo_tree")
phylo_counts <- ecostructure_prepare_by_phylo(taxonomic_counts,
                                             phylo_tree, collapse_at = 10)
dim(phylo_counts$outdat)
```



### Trait

We use bill trait metadata from `himalayan_birds` data and then use the distance
metric based on these traits to collapse the bird species.

```{r}
bill_traits <- as.matrix(dist(scale(species_metadata[,c(1:3)])))
counts_bill_traits <- ecostructure_prepare_by_trait(counts = taxonomic_counts, 
                                                    traits = bill_traits, 
                                                    prop_div=0.3)
dim(counts_bill_traits)
```

You can see that based on bill traits, the species are collapsed into $91$ bins.

### Regional

We can use region-based dispersion assemblage fields to define new features. 
One can generate such a data starting from the `taxonomic_counts` above.

This is a time consuming exercise and shapefiles for birds are too big to
distribute as part of a package, but the following presents an example
interface.

```{r echo=TRUE, eval=FALSE}
disp <- dispersion_fields_create(taxonomic_counts, 
                                 shapefiles_dir = "all_bird_shapefiles/")
regional_counts <- dispersion_fields_to_matrix(disp)
```


## SessionInfo

```{r}
sessionInfo()
```

